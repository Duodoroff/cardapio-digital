<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nosso Cardápio Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Animação suave para scroll */
        html {
            scroll-behavior: smooth;
        }
        /* Estilo para a imagem de fundo da categoria */
        .category-header-bg {
            background-size: cover;
            background-position: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 max-w-5xl">
        <!-- O cabeçalho será preenchido pelo JS -->
        <header id="main-header" class="text-center mb-6 md:mb-10">
            <!-- Logo e nome do restaurante aqui -->
        </header>

        <!-- Filtros de Categoria -->
        <div id="category-filters" class="sticky top-0 bg-gray-50/95 backdrop-blur-sm py-4 z-10 mb-8">
            <div id="filters-container" class="flex flex-wrap justify-center gap-2">
                <!-- Botões de filtro serão inseridos aqui -->
            </div>
        </div>

        <!-- Indicador de Carregamento -->
        <div id="loading" class="text-center py-10">
            <p class="text-lg text-gray-500">A carregar o cardápio...</p>
        </div>

        <!-- Container do Cardápio -->
        <main id="menu-container" class="space-y-12">
            <!-- As categorias e itens do cardápio aparecerão aqui -->
        </main>

        <!-- Rodapé com informações de contato -->
        <footer id="main-footer" class="text-center mt-16 py-8 border-t border-gray-200 text-gray-600">
            <!-- Informações de contato e redes sociais aqui -->
        </footer>
    </div>

    <script>
        // --- PASSO IMPORTANTE ---
        // Verifique se as 3 URLs abaixo estão corretas e se as planilhas estão publicadas.
        const GOOGLE_SHEETS_URLS = {
            items: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRLlJ0SbuZ1nY5EwMXxO9vN7tf9JQMh7Vh3qvOIkH62VelfXaj5fa6FHdbY9MdMb-pUmI2dHuuHQ3Fx/pub?gid=531775951&single=true&output=csv',
            categories: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRLlJ0SbuZ1nY5EwMXxO9vN7tf9JQMh7Vh3qvOIkH62VelfXaj5fa6FHdbY9MdMb-pUmI2dHuuHQ3Fx/pub?gid=1791212980&single=true&output=csv',
            config: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRLlJ0SbuZ1nY5EwMXxO9vN7tf9JQMh7Vh3qvOIkH62VelfXaj5fa6FHdbY9MdMb-pUmI2dHuuHQ3Fx/pub?gid=81577097&single=true&output=csv'
        };

        // --- Elementos do DOM ---
        const menuContainer = document.getElementById('menu-container');
        const loadingIndicator = document.getElementById('loading');
        const categoryFiltersContainer = document.getElementById('filters-container');
        const mainHeader = document.getElementById('main-header');
        const mainFooter = document.getElementById('main-footer');

        // --- Funções de Processamento de CSV ---
        // **NOVO PARSER DE CSV ROBUSTO**
        // Este parser consegue lidar com vírgulas dentro de campos de texto (descrições).
        const parseCsv = (text) => {
            if (!text) return [];
            const lines = text.trim().replace(/\r/g, '').split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) return [];

            const header = lines[0].split(',').map(h => h.trim());
            const regex = /(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|([^\",\r\n]*))(?:\,|\r\n|\n|$)/g;

            const rows = lines.slice(1).map(line => {
                const rowValues = [];
                let match;
                // Usa a regex para extrair os valores corretamente
                while (match = regex.exec(line)) {
                    // Se o valor estava entre aspas, usa o grupo 1; senão, usa o grupo 2.
                    let value = match[1] !== undefined ? match[1].replace(/\"\"/g, '\"') : match[2];
                    if (value) {
                       rowValues.push(value.trim());
                    }
                }
                
                let obj = {};
                header.forEach((h, i) => {
                    obj[h] = rowValues[i];
                });
                return obj;
            });
            return rows;
        };
        
        // --- Funções de Renderização ---
        function renderHeader(config) {
            const nomeRestaurante = config['Nome Restaurante'] || 'O Nosso Cardápio';
            const slogan = config['Slogan'] || 'Feito com carinho para si!';
            document.title = nomeRestaurante;
            mainHeader.innerHTML = `<h1 class="text-4xl md:text-5xl font-bold text-gray-900">${nomeRestaurante}</h1><p class="text-gray-600 mt-2 text-lg">${slogan}</p>`;
        }

        function renderFooter(config) {
             const whatsapp = config['WhatsApp'];
             const instagram = config['Instagram URL'];
             const facebook = config['Facebook URL'];
             const ano = new Date().getFullYear();
             const nomeRestaurante = config['Nome Restaurante'] || 'O Seu Restaurante';
             let socialLinks = '';
             if (whatsapp) socialLinks += `<a href="https://wa.me/${whatsapp.replace(/\D/g,'')}" target="_blank" class="text-green-600 hover:underline mx-2">WhatsApp</a>`;
             if (instagram) socialLinks += `<a href="${instagram}" target="_blank" class="text-pink-600 hover:underline mx-2">Instagram</a>`;
             if (facebook) socialLinks += `<a href="${facebook}" target="_blank" class="text-blue-800 hover:underline mx-2">Facebook</a>`;
             mainFooter.innerHTML = `<div class="mb-4">${socialLinks}</div><p>&copy; ${ano} ${nomeRestaurante}. Todos os direitos reservados.</p>`;
        }

        function renderFilters(categories) {
            categoryFiltersContainer.innerHTML = `<a href="#menu-container" onclick="event.preventDefault(); window.scrollTo(0, mainHeader.offsetHeight + 50);" class="px-4 py-2 bg-yellow-600 text-white rounded-full shadow-sm hover:bg-yellow-700 transition-colors">Todos</a>`;
            categories.forEach(category => {
                const filterButton = document.createElement('a');
                filterButton.href = `#category-${category.Nome_Categoria.replace(/\s+/g, '-')}`;
                filterButton.textContent = category.Titulo_Exibicao;
                filterButton.className = "px-4 py-2 bg-white text-gray-700 rounded-full shadow-sm hover:bg-gray-200 transition-colors";
                categoryFiltersContainer.appendChild(filterButton);
            });
        }

        function formatPrice(priceString) {
            if (!priceString) return '';
            const numericString = priceString.replace('R$', '').trim().replace(',', '.');
            const priceNumber = parseFloat(numericString);
            if (!isNaN(priceNumber)) {
                return `R$ ${priceNumber.toFixed(2).replace('.', ',')}`;
            }
            return priceString; // Retorna o texto original se não for um número (ex: "Consultar preço")
        }

        function renderMenu(categories, items) {
            menuContainer.innerHTML = '';
            categories.forEach(category => {
                const categoryItems = items.filter(item => item.Categoria === category.Nome_Categoria);
                if (categoryItems.length === 0) return;
                const categoryId = `category-${category.Nome_Categoria.replace(/\s+/g, '-')}`;
                const categorySection = document.createElement('section');
                categorySection.id = categoryId;
                categorySection.className = "pt-4";
                categorySection.innerHTML = `
                    <div class="category-header-bg rounded-xl p-8 md:p-12 mb-8 shadow-lg flex flex-col justify-center items-center text-center" style="background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('${category.Foto_Categoria}')">
                        <h2 class="text-3xl md:text-4xl font-bold">${category.Titulo_Exibicao}</h2>
                        <p class="mt-2 max-w-2xl">${category.Descricao_Secao}</p>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        ${categoryItems.map(item => `
                            <div class="bg-white rounded-lg shadow-md overflow-hidden flex transform hover:scale-105 transition-transform duration-300">
                                <img src="${item.Foto_URL}" alt="${item.Nome}" class="w-1/3 h-full object-cover" onerror="this.style.display='none'">
                                <div class="p-4 flex flex-col flex-grow">
                                    <div class="flex justify-between items-start mb-1">
                                        <h3 class="text-xl font-bold text-gray-800">${item.Nome}</h3>
                                        <p class="text-lg font-semibold text-green-700 whitespace-nowrap ml-4">${formatPrice(item.Preco)}</p>
                                    </div>
                                    <p class="text-gray-600 flex-grow">${item.Descricao}</p>
                                </div>
                            </div>`).join('')}
                    </div>`;
                menuContainer.appendChild(categorySection);
            });
        }

        // --- Função Principal com Diagnósticos ---
        async function initMenu() {
            try {
                const [itemsResponse, categoriesResponse, configResponse] = await Promise.all([
                    fetch(GOOGLE_SHEETS_URLS.items),
                    fetch(GOOGLE_SHEETS_URLS.categories),
                    fetch(GOOGLE_SHEETS_URLS.config)
                ]);

                if (!itemsResponse.ok) throw new Error("Falha ao carregar os ITENS. Verifique a URL e as permissões da planilha de Itens.");
                if (!categoriesResponse.ok) throw new Error("Falha ao carregar as CATEGORIAS. Verifique a URL e as permissões da planilha de Categorias.");
                if (!configResponse.ok) throw new Error("Falha ao carregar a CONFIGURAÇÃO. Verifique a URL e as permissões da planilha de Config.");

                const [itemsCsv, categoriesCsv, configCsv] = await Promise.all([
                    itemsResponse.text(),
                    categoriesResponse.text(),
                    configResponse.text()
                ]);

                const items = parseCsv(itemsCsv);
                const categories = parseCsv(categoriesCsv);
                const configData = parseCsv(configCsv);

                if (categories.length === 0) throw new Error("Nenhuma categoria foi encontrada. Verifique se a planilha 'Categorias' está publicada, possui dados e o cabeçalho correto.");
                if (items.length === 0) throw new Error("Nenhum item foi encontrado. Verifique se a planilha 'Itens' está publicada e possui dados.");
                
                const config = configData.reduce((obj, item) => { obj[item.Campo] = item.Valor; return obj; }, {});
                
                renderHeader(config);
                renderFooter(config);
                renderFilters(categories);
                renderMenu(categories, items);

                if (menuContainer.innerHTML.trim() === '') {
                    throw new Error("Cardápio carregado, mas nenhum item correspondeu às categorias. Verifique se os nomes na coluna 'Categoria' (planilha de Itens) são EXATAMENTE iguais aos nomes na coluna 'Nome_Categoria' (planilha de Categorias).");
                }

            } catch (error) {
                console.error('ERRO DETALHADO:', error);
                menuContainer.innerHTML = `<div class="text-center p-8 bg-red-100 rounded-lg"><h3 class="font-bold text-red-800 text-lg">Ocorreu um Erro</h3><p class="text-red-700 mt-2">${error.message}</p></div>`;
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        // Inicia o processo
        initMenu();
    </script>
</body>
</html>
