<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O Nosso Cardápio Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        html {
            scroll-behavior: smooth;
        }
        .category-header-bg {
            background-size: cover;
            background-position: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 max-w-5xl">
        <header id="main-header" class="text-center mb-6 md:mb-10"></header>

        <div id="category-filters" class="sticky top-0 bg-gray-50/95 backdrop-blur-sm py-4 z-10 mb-8">
            <div id="filters-container" class="flex flex-wrap justify-center gap-2"></div>
        </div>

        <div id="loading" class="text-center py-10">
            <p class="text-lg text-gray-500">A carregar o cardápio...</p>
        </div>

        <main id="menu-container" class="space-y-12"></main>

        <footer id="main-footer" class="text-center mt-16 py-8 border-t border-gray-200 text-gray-600"></footer>
    </div>

    <script>
        const GOOGLE_SHEETS_URLS = {
            categories: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRLlJ0SbuZ1nY5EwMXxO9vN7tf9JQMh7Vh3qvOIkH62VelfXaj5fa6FHdbY9MdMb-pUmI2dHuuHQ3Fx/pub?gid=1791212980&single=true&output=csv',
            items: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRLlJ0SbuZ1nY5EwMXxO9vN7tf9JQMh7Vh3qvOIkH62VelfXaj5fa6FHdbY9MdMb-pUmI2dHuuHQ3Fx/pub?gid=531775951&single=true&output=csv',
            config: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRLlJ0SbuZ1nY5EwMXxO9vN7tf9JQMh7Vh3qvOIkH62VelfXaj5fa6FHdbY9MdMb-pUmI2dHuuHQ3Fx/pub?gid=81577097&single=true&output=csv'
        };

        const menuContainer = document.getElementById('menu-container');
        const loadingIndicator = document.getElementById('loading');
        const categoryFiltersContainer = document.getElementById('filters-container');
        const mainHeader = document.getElementById('main-header');
        const mainFooter = document.getElementById('main-footer');

        // --- NOVO PARSER DE CSV MAIS ESTÁVEL ---
        const parseCsv = (text) => {
            const lines = text.trim().replace(/\r/g, '').split('\n');
            if (lines.length < 2) return [];
            
            const header = lines[0].split(',').map(h => h.trim());
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const row = [];
                let field = '';
                let inQuotes = false;

                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];

                    if (char === '"' && lines[i][j+1] === '"') {
                        field += '"';
                        j++; // Ignora a próxima aspa
                    } else if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(field);
                        field = '';
                    } else {
                        field += char;
                    }
                }
                row.push(field); // Adiciona o último campo

                const obj = {};
                header.forEach((h, k) => {
                    obj[h] = row[k] ? row[k].trim() : '';
                });
                rows.push(obj);
            }
            return rows;
        };
        
        function renderHeader(config) {
            const nomeRestaurante = config['Nome Restaurante'] || 'O Nosso Cardápio';
            const slogan = config['Slogan'] || 'Feito com carinho para si!';
            document.title = nomeRestaurante;
            mainHeader.innerHTML = `<h1 class="text-4xl md:text-5xl font-bold text-gray-900">${nomeRestaurante}</h1><p class="text-gray-600 mt-2 text-lg">${slogan}</p>`;
        }

        function renderFooter(config) {
             const whatsapp = config['WhatsApp'];
             const instagram = config['Instagram URL'];
             const facebook = config['Facebook URL'];
             const ano = new Date().getFullYear();
             const nomeRestaurante = config['Nome Restaurante'] || 'O Seu Restaurante';
             let socialLinks = '';
             if (whatsapp) socialLinks += `<a href="https://wa.me/${whatsapp.replace(/\D/g,'')}" target="_blank" class="text-green-600 hover:underline mx-2">WhatsApp</a>`;
             if (instagram) socialLinks += `<a href="${instagram}" target="_blank" class="text-pink-600 hover:underline mx-2">Instagram</a>`;
             if (facebook) socialLinks += `<a href="${facebook}" target="_blank" class="text-blue-800 hover:underline mx-2">Facebook</a>`;
             mainFooter.innerHTML = `<div class="mb-4">${socialLinks}</div><p>&copy; ${ano} ${nomeRestaurante}. Todos os direitos reservados.</p>`;
        }

        function renderFilters(categories) {
            categoryFiltersContainer.innerHTML = `<a href="#menu-container" onclick="event.preventDefault(); window.scrollTo(0, mainHeader.offsetHeight + 50);" class="px-4 py-2 bg-yellow-600 text-white rounded-full shadow-sm hover:bg-yellow-700 transition-colors">Todos</a>`;
            categories.forEach(category => {
                const filterButton = document.createElement('a');
                
                const buttonText = category['Título_Exibição'] || category['Nome_Categoria'];
                const categoryId = category['Nome_Categoria'] || '';

                filterButton.href = `#category-${categoryId.replace(/\s+/g, '-')}`;
                filterButton.textContent = buttonText;
                
                // CORREÇÃO: Estilo melhorado para garantir a visibilidade
                filterButton.className = "px-4 py-2 bg-white text-gray-800 border border-gray-300 rounded-full shadow-sm hover:bg-gray-200 transition-colors";
                
                categoryFiltersContainer.appendChild(filterButton);
            });
        }

        function formatPrice(priceString) {
            if (!priceString) return '';
            const numericString = priceString.replace('R$', '').trim().replace(',', '.');
            const priceNumber = parseFloat(numericString);
            if (!isNaN(priceNumber)) {
                return `R$ ${priceNumber.toFixed(2).replace('.', ',')}`;
            }
            return priceString;
        }

        function renderMenu(categories, items) {
            menuContainer.innerHTML = '';
            categories.forEach(category => {
                const categoryItems = items.filter(item => item['Categoria'] === category['Nome_Categoria']);
                if (categoryItems.length === 0) return;
                const categoryId = `category-${category['Nome_Categoria'].replace(/\s+/g, '-')}`;
                const categorySection = document.createElement('section');
                categorySection.id = categoryId;
                categorySection.className = "pt-4";
                categorySection.innerHTML = `
                    <div class="category-header-bg rounded-xl p-8 md:p-12 mb-8 shadow-lg flex flex-col justify-center items-center text-center" style="background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('${category['Foto_Categoria']}')">
                        <h2 class="text-3xl md:text-4xl font-bold">${category['Título_Exibição']}</h2>
                        <p class="mt-2 max-w-2xl">${category['Descrição_Seção']}</p>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        ${categoryItems.map(item => `
                            <div class="bg-white rounded-lg shadow-md overflow-hidden flex transform hover:scale-105 transition-transform duration-300">
                                <img src="${item['Foto_URL']}" alt="${item['Nome']}" class="w-1/3 h-full object-cover" loading="lazy" onerror="this.style.display='none'">
                                <div class="p-4 flex flex-col flex-grow">
                                    <div class="flex justify-between items-start mb-1">
                                        <h3 class="text-xl font-bold text-gray-800">${item['Nome']}</h3>
                                        <p class="text-lg font-semibold text-green-700 whitespace-nowrap ml-4">${formatPrice(item['Preço'])}</p>
                                    </div>
                                    <p class="text-gray-600 flex-grow">${item['Descrição']}</p>
                                </div>
                            </div>`).join('')}
                    </div>`;
                menuContainer.appendChild(categorySection);
            });
        }

        async function fetchWithTimeout(resource, options = {}) {
            const { timeout = 8000 } = options;
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch(resource, { ...options, signal: controller.signal });
                return response;
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error(`A requisição para ${resource} demorou demasiado tempo (mais de 8 segundos).`);
                }
                throw error;
            } finally {
                clearTimeout(id);
            }
        }

        async function initMenu() {
            const cacheKey = 'cardapioData';
            const cacheDuration = 15 * 60 * 1000;

            try {
                const cachedData = localStorage.getItem(cacheKey);
                if (cachedData) {
                    const { timestamp, data } = JSON.parse(cachedData);
                    if (Date.now() - timestamp < cacheDuration) {
                        console.log("A carregar cardápio do cache.");
                        renderAll(data.categories, data.items, data.config);
                        return;
                    }
                }

                console.log("A buscar novos dados do cardápio...");
                
                const dataSources = [
                    { key: 'categories', name: 'Categorias' },
                    { key: 'items', name: 'Itens' },
                    { key: 'config', name: 'Configuração' }
                ];

                const allData = {};

                for (const source of dataSources) {
                    loadingIndicator.querySelector('p').textContent = `A carregar ${source.name}...`;
                    const response = await fetchWithTimeout(GOOGLE_SHEETS_URLS[source.key]);
                    if (!response.ok) throw new Error(`Falha ao carregar os dados de ${source.name}.`);
                    const csvText = await response.text();
                    const parsedData = parseCsv(csvText);
                    if (parsedData.length === 0) throw new Error(`Os dados de ${source.name} parecem estar vazios.`);
                    allData[source.key] = parsedData;
                }

                const { categories, items } = allData;
                const config = allData.config.reduce((obj, item) => { obj[item['Campo']] = item['Valor']; return obj; }, {});
                
                localStorage.setItem(cacheKey, JSON.stringify({ timestamp: Date.now(), data: { categories, items, config } }));
                
                renderAll(categories, items, config);

            } catch (error) {
                console.error('ERRO DETALHADO:', error);
                menuContainer.innerHTML = `<div class="text-center p-8 bg-red-100 rounded-lg"><h3 class="font-bold text-red-800 text-lg">Ocorreu um Erro</h3><p class="text-red-700 mt-2">${error.message}</p></div>`;
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function renderAll(categories, items, config) {
            renderHeader(config);
            renderFooter(config);
            renderFilters(categories);
            renderMenu(categories, items);

            if (menuContainer.innerHTML.trim() === '') {
                menuContainer.innerHTML = `<div class="text-center p-8 bg-yellow-100 rounded-lg"><h3 class="font-bold text-yellow-800 text-lg">Aviso</h3><p class="text-yellow-700 mt-2">Cardápio carregado, mas nenhum item correspondeu às categorias. Verifique se os nomes nas suas planilhas.</p></div>`;
            }
        }

        initMenu();
    </script>
</body>
</html>
